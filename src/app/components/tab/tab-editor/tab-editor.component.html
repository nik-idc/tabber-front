<div
  *ngIf="tabWindow"
  class="tab-div"
  tabindex="0"
  (keydown.control.delete)="onTabCtrlDel()"
  (keydown)="onTabKeyDown($event)"
>
  <div class="tab-controls">
    <div class="note-controls">
      <button
        mat-button
        *ngFor="let duration of [1, 2, 4, 8, 16, 32]"
        (click)="onNoteDurationClick(1 / duration)"
      >
        <img
          class="note-svg"
          [attr.src]="'../../../assets/img/notes/' + duration + '.svg'"
        />
      </button>
    </div>
    <div class="play-controls">
      <button mat-button (click)="onPlayClicked()">
        <mat-icon *ngIf="!isPlaying">play_arrow</mat-icon>
        <mat-icon *ngIf="isPlaying">pause</mat-icon>
      </button>
    </div>
    <div class="rhythm-controls">
      <table cellspacing="0">
        <tr>
          <td>
            <mat-form-field class="bar-settings-input">
              <mat-label>Bar beats</mat-label>
              <mat-select
                (selectionChange)="onBeatsChanged($event)"
                [disabled]="tabWindow.getSelectedElement() === undefined"
              >
                <mat-option
                  *ngFor="
                    let beat of [
                      1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,
                      18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 3132
                    ]
                  "
                  [value]="beat"
                >
                  {{ beat }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
          <td>
            <mat-form-field class="bar-settings-input">
              <mat-label>Bar duration</mat-label>
              <mat-select
                (selectionChange)="onDurationChanged($event)"
                [disabled]="tabWindow.getSelectedElement() === undefined"
              >
                <mat-option
                  *ngFor="let duration of [1, 2, 4, 8, 16, 32]"
                  [value]="duration"
                >
                  {{ duration }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
          <td>
            <mat-form-field class="bar-settings-input">
              <mat-label>Tempo</mat-label>
              <input
                matInput
                type="number"
                min="1"
                max="400"
                [disabled]="tabWindow.getSelectedElement() === undefined"
                [value]="
                  tabWindow.getSelectedElement() !== undefined
                    ? tabWindow.getSelectedElement()!.bar.tempo
                    : undefined
                "
                (change)="onTempoChanged($event)"
              />
            </mat-form-field>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <svg
    [attr.width]="tabWindow.dim.width"
    [attr.height]="getTabWindowHeight()"
    class="tab-svg"
  >
    <g
      *ngFor="
        let tabLineElement of tabWindow.getTabLineElements();
        let tabLineElementId = index
      "
    >
      {{ setTabLineElementOffset(tabLineElement) }}
      <g
        *ngFor="
          let barElement of tabLineElement.barElements;
          let barElementId = index
        "
      >
        {{ setBarElementOffset(barElement) }}
        <line
          [attr.x1]="barOffset.x + barElement.barLeftBorderLine[0].x"
          [attr.y1]="barOffset.y + barElement.barLeftBorderLine[0].y"
          [attr.x2]="barOffset.x + barElement.barLeftBorderLine[1].x"
          [attr.y2]="barOffset.y + barElement.barLeftBorderLine[1].y"
          class="bar-line"
        />

        <line
          *ngFor="let line of barElement.staffLines"
          [attr.x1]="barOffset.x + line[0].x"
          [attr.y1]="barOffset.y + line[0].y"
          [attr.x2]="barOffset.x + line[1].x"
          [attr.y2]="barOffset.y + line[1].y"
          [ngClass]="{
            'bar-line': barElement.durationsFit,
            'error-bar-line': !barElement.durationsFit
          }"
        />

        <g *ngIf="barElement.showSignature">
          <text
            [attr.x]="barOffset.x + barElement.beatsTextCoords.x"
            [attr.y]="barOffset.y + barElement.beatsTextCoords.y"
            [attr.font-size]="tabWindow.dim.timeSigTextSize"
          >
            {{ barElement.bar.beatsCount }}
          </text>

          <text
            [attr.x]="barOffset.x + barElement.measureTextCoords.x"
            [attr.y]="barOffset.y + barElement.measureTextCoords.y"
            [attr.font-size]="tabWindow.dim.timeSigTextSize"
          >
            {{ 1 / barElement.bar.duration }}
          </text>
        </g>

        <g *ngIf="barElement.showTempo">
          <image
            [attr.x]="barOffset.x + barElement.tempoImageRect.x"
            [attr.y]="barOffset.y + barElement.tempoImageRect.y"
            [attr.width]="barElement.tempoImageRect.width"
            [attr.height]="barElement.tempoImageRect.height"
            href="./assets/img/notes/4.svg"
          />

          <text
            [attr.x]="barOffset.x + barElement.tempoTextCoords.x"
            [attr.y]="barOffset.y + barElement.tempoTextCoords.y"
            [attr.font-size]="tabWindow.dim.tempoTextSize"
            text-anchor="start"
          >
            = {{ barElement.bar.tempo }}
          </text>
        </g>

        <g
          *ngFor="
            let beatElement of barElement.beatElements;
            let beatElementId = index
          "
          (mousedown)="
            onBeatMouseDown(tabLineElementId, barElementId, beatElementId)
          "
          (mouseenter)="
            onBeatMouseEnter(tabLineElementId, barElementId, beatElementId)
          "
          (mouseleave)="
            onBeatMouseLeave(tabLineElementId, barElementId, beatElementId)
          "
          (mousemove)="
            onBeatMouseMove(
              $event,
              tabLineElementId,
              barElementId,
              beatElementId
            )
          "
          (mouseup)="onBeatMouseUp()"
        >
          {{ setBeatElementOffset(beatElement) }}
          <g
            *ngFor="let effectLabelElement of beatElement.effectLabelElements"
            [attr.transform]="
              'translate(' + beatOffset.x + ',' + beatOffset.y + ')'
            "
          >
            <g
              *ngIf="effectLabelElement.fullHTML !== undefined"
              [innerHTML]="sanitizeSVG(effectLabelElement.fullHTML)"
            ></g>
          </g>

          <image
            [attr.x]="beatOffset.x + beatElement.durationRect.x"
            [attr.y]="beatOffset.y + beatElement.durationRect.y"
            [attr.width]="beatElement.durationRect.width"
            [attr.height]="beatElement.durationRect.height"
            [attr.href]="
              '../../../assets/img/notes/' +
              1 / beatElement.beat.duration +
              '.svg'
            "
          />
          {{ setBeatNotesOffset(beatElement.beatNotesElement) }}
          <g
            *ngFor="
              let noteElement of beatElement.beatNotesElement.noteElements;
              let noteElementId = index
            "
            (click)="
              onNoteClick(
                tabLineElementId,
                barElementId,
                beatElementId,
                noteElementId
              )
            "
          >
            <g *ngFor="let effectElement of noteElement.guitarEffectElements">
              <g *ngIf="effectElement.rect !== undefined">
                <rect
                  [attr.x]="beatNotesOffset.x + effectElement.rect.x"
                  [attr.y]="beatNotesOffset.y + effectElement.rect.y"
                  [attr.width]="effectElement.rect.width"
                  [attr.height]="effectElement.rect.height"
                  fill="white"
                  stroke-opacity="0"
                />
              </g>

              <g *ngIf="effectElement.fullHTML !== undefined">
                <g
                  [attr.transform]="
                    'translate(' +
                    beatNotesOffset.x +
                    ',' +
                    beatNotesOffset.y +
                    ')'
                  "
                >
                  <g [innerHTML]="sanitizeSVG(effectElement.fullHTML)"></g>
                </g>
              </g>
            </g>
            />

            <rect
              [attr.x]="beatNotesOffset.x + noteElement.rect.x"
              [attr.y]="beatNotesOffset.y + noteElement.rect.y"
              [attr.width]="noteElement.rect.width"
              [attr.height]="noteElement.rect.height"
              class="note-select-rect"
            />

            <g
              *ngIf="
                noteElement.note.fret !== undefined ||
                (tabWindow.getSelectedElement() &&
                  noteElement.note.uuid ===
                    tabWindow.getSelectedElement()!.note.uuid)
              "
            >
              <rect
                [attr.x]="beatNotesOffset.x + noteElement.textRect.x"
                [attr.y]="beatNotesOffset.y + noteElement.textRect.y"
                [attr.width]="noteElement.textRect.width"
                [attr.height]="noteElement.textRect.height"
                [ngClass]="{
                  'note-select-text-rect':
                    tabWindow.getSelectedElement() &&
                    noteElement.note.uuid ===
                      tabWindow.getSelectedElement()!.note.uuid,
                  'note-text-rect': !(
                    tabWindow.getSelectedElement() &&
                    noteElement.note.uuid ===
                      tabWindow.getSelectedElement()!.note.uuid
                  )
                }"
              />

              <text
                [attr.x]="beatNotesOffset.x + noteElement.textCoords.x"
                [attr.y]="beatNotesOffset.y + noteElement.textCoords.y"
                [attr.font-size]="noteElement.dim.noteTextSize"
                class="note-text"
              >
                {{ noteElement.note.fret }}
              </text>
            </g>
          </g>

          <g *ngIf="beatElement.selected">
            <rect
              [attr.x]="barOffset.x + beatElement.rect.x"
              [attr.y]="barOffset.y + beatElement.rect.y"
              [attr.width]="beatElement.rect.width"
              [attr.height]="beatElement.rect.height"
              class="selected-beat-rect"
              fill="blue"
              fill-opacity="0.25"
            />
          </g>
        </g>
        <line
          [attr.x1]="barOffset.x + barElement.barRightBorderLine[0].x"
          [attr.y1]="barOffset.y + barElement.barRightBorderLine[0].y"
          [attr.x2]="barOffset.x + barElement.barRightBorderLine[1].x"
          [attr.y2]="barOffset.y + barElement.barRightBorderLine[1].y"
          class="bar-line"
        />
      </g>

      <rect
        id="playerCursor"
        stroke="black"
        fill="purple"
      />

      <!-- <rect

              [attr.x]="getPlayerCursorRect().x"
        [attr.y]="getPlayerCursorRect().y"

        *ngIf="tabWindow.tabElement.selectionRects[tabLineElementId]"
        [attr.x]="tabWindow.tabElement.selectionRects[tabLineElementId]!.x"
        [attr.y]="tabWindow.tabElement.selectionRects[tabLineElementId]!.y"
        [attr.width]="
          tabWindow.tabElement.selectionRects[tabLineElementId]!.width
        "
        [attr.height]="
          tabWindow.tabElement.selectionRects[tabLineElementId]!.height
        "
        class="beat-selected"
      /> -->
    </g>
  </svg>
</div>
